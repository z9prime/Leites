<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>ACESSO RESTRITO: COFRE</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <nav>
        <a href="index.html">PAINEL OPERA√á√ïES</a>
        <a href="cofre.html" class="active">O COFRE</a>
    </nav>

    <div class="container vault-container">
        <div class="big-lock">üîí</div>
        <h2>FUNDO DE CONTRA-ATAQUE (VIL√ÉO)</h2>
        
        <div class="vault-amount" id="bigVaultDisplay">
            CARREGANDO...
        </div>

        <div class="wallets-grid">
            <div class="wallet-card hero-wallet">
                <h4>MINHA CARTEIRA (LUCRO)</h4>
                <div class="wallet-balance" id="walletHero">‚Ç¨ 0.00</div>
                
                <div class="deposit-area">
                    <input type="number" id="inputHero" placeholder="Valor" step="0.5">
                    <button onclick="depositar('Heroi')">ENVIAR P/ COFRE ‚ûî</button>
                </div>
            </div>

            <div class="wallet-card bro-wallet">
                <h4>CARTEIRA IRM√ÉO (LUCRO)</h4>
                <div class="wallet-balance" id="walletBro">‚Ç¨ 0.00</div>

                <div class="deposit-area">
                    <input type="number" id="inputBro" placeholder="Valor" step="0.5">
                    <button onclick="depositar('Irmao')">ENVIAR P/ COFRE ‚ûî</button>
                </div>
            </div>
        </div>

        <p style="opacity: 0.6; max-width: 600px; margin: 30px auto;">
            Este fundo √© intoc√°vel. Representa 20% de todos os lucros + Contribui√ß√µes volunt√°rias.
            <br>
            OBJETIVO: <span style="color: var(--primary)">FAL√äNCIA DO ALVO</span>
        </p>

        <div style="margin-top: 50px; border-top: 1px solid #333; padding-top: 20px;">
            <h3>√öLTIMAS MOVIMENTA√á√ïES</h3>
            <ul id="vaultLogs" style="list-style: none; padding: 0; color: var(--primary);">
            </ul>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO SUPABASE (AS MESMAS DO SCRIPT.JS) ---
        const supabaseUrl = 'https://euxfddzviktggfwefxhf.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1eGZkZHp2aWt0Z2dmd2VmeGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMTAwMzEsImV4cCI6MjA4MDY4NjAzMX0.oNfGbI8UaK9zUSLQkb5LfXRh8Ozhu-SNAeNaWYr7bS8';

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Vari√°veis globais para valida√ß√£o
        let saldoAtualHero = 0;
        let saldoAtualBro = 0;

        async function loadVault() {
            // Selecionamos TUDO para poder calcular os saldos individuais
            const { data, error } = await supabaseClient
                .from('historico_operacoes')
                .select('*') 
                .order('data_operacao', { ascending: false });

            if (error) {
                console.error("Erro ao carregar:", error);
                document.getElementById('bigVaultDisplay').innerText = "ERRO";
                return;
            }

            let totalCofre = 0;
            let totalHero = 0;
            let totalBro = 0;

            const list = document.getElementById('vaultLogs');
            list.innerHTML = ''; // Limpa a lista antes de encher

            if (data) {
                data.forEach((op, index) => {
                    // 1. Soma Cofre
                    totalCofre += parseFloat(op.valor_para_cofre);

                    // 2. Soma Carteiras Individuais (Baseado no Lucro L√≠quido Vencedor)
                    // Se eu depositei, o meu lucro l√≠quido na DB √© negativo, ent√£o subtrai automaticamente
                    if (op.vencedor && op.vencedor.toUpperCase().includes('EU')) {
                        totalHero += parseFloat(op.lucro_liquido_vencedor || 0);
                    } 
                    else if (op.vencedor && op.vencedor.toUpperCase().includes('IRM√ÉO')) {
                        totalBro += parseFloat(op.lucro_liquido_vencedor || 0);
                    }

                    // Logs (Top 5)
                    if (index < 5) {
                        const li = document.createElement('li');
                        const dataF = new Date(op.data_operacao).toLocaleDateString('pt-PT');
                        const val = parseFloat(op.valor_para_cofre);
                        const isPos = val >= 0;
                        
                        li.innerHTML = `
                            <span style="color: ${isPos ? 'var(--primary)' : 'red'}">
                                ${isPos ? '+' : ''} ‚Ç¨ ${val.toFixed(2)}
                            </span> 
                            <small style="color: #666">(${op.nome_jogo || 'Opera√ß√£o'} - ${dataF})</small>`;
                        list.appendChild(li);
                    }
                });
            }

            // Atualiza UI
            document.getElementById('bigVaultDisplay').innerText = `‚Ç¨ ${totalCofre.toFixed(2)}`;
            
            saldoAtualHero = totalHero;
            document.getElementById('walletHero').innerText = `‚Ç¨ ${totalHero.toFixed(2)}`;

            saldoAtualBro = totalBro;
            document.getElementById('walletBro').innerText = `‚Ç¨ ${totalBro.toFixed(2)}`;
        }

        // --- FUN√á√ÉO PARA DEPOSITAR DINHEIRO DAS CARTEIRAS ---
        async function depositar(quem) {
            let inputId = quem === 'Heroi' ? 'inputHero' : 'inputBro';
            let valor = parseFloat(document.getElementById(inputId).value);
            let saldoDisponivel = quem === 'Heroi' ? saldoAtualHero : saldoAtualBro;
            let nomeVencedor = quem === 'Heroi' ? "EU (Aporte Manual)" : "IRM√ÉO (Aporte Manual)";

            // Valida√ß√µes
            if (!valor || valor <= 0) {
                alert("Mano, digita um valor v√°lido.");
                return;
            }
            if (valor > saldoDisponivel) {
                alert(`Saldo insuficiente! S√≥ tens ‚Ç¨${saldoDisponivel.toFixed(2)}.`);
                return;
            }

            // Inserir transa√ß√£o
            // valor_para_cofre: POSITIVO (Entra no cofre)
            // lucro_liquido_vencedor: NEGATIVO (Sai da carteira da pessoa)
            const { error } = await supabaseClient.from('historico_operacoes').insert([{
                nome_jogo: "CONTRIBUI√á√ÉO VOLUNT√ÅRIA",
                investimento_total: 0,
                vencedor: nomeVencedor,
                lucro_bruto: 0,
                valor_para_cofre: valor,
                valor_solidariedade: 0,
                lucro_liquido_vencedor: -valor 
            }]);

            if (error) {
                console.error(error);
                alert("Erro ao depositar.");
            } else {
                // Sucesso
                document.getElementById(inputId).value = "";
                loadVault(); // Recarrega tudo
            }
        }

        loadVault();
    </script>
</body>
</html>
